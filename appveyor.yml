image: Visual Studio 2017
platform:
  - x64
version: '{build}'

environment:
  BINTRAY: http://dl.bintray.com/lamyj/generic
  VCPKG_EXPORT: vcpkg-export-20181101-093017

init:
  # - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
  
install:
  - ps: |
      git clone -q https://github.com/lamyj/odil.git "${env:APPVEYOR_BUILD_FOLDER}\odil"
  # This archive was obtained by:
  # vcpkg export --7zip --triplet x64-windows
  #   boost-asio boost-date-time boost-filesystem boost-fusion  boost-iostreams
  #   boost-lexical-cast boost-log boost-property-tree boost-spirit boost-test
  #   boost-uuid dcmtk icu jsoncpp pybind11 zlib
  # WARNING: DCMTK is built with -DBUILD_APPS=OFF
  - ps: |
      if(!(test-path "${env:VCPKG_EXPORT}.7z")) 
      { 
        Invoke-RestMethod `
          "${env:BINTRAY}/vcpkg-exports/${env:VCPKG_EXPORT}.7z" `
          -outfile "${env:VCPKG_EXPORT}.7z"
      }
      7z x "${env:VCPKG_EXPORT}.7z" -aos -o"c:\tools\vcpkg"
      choco install ninja
  
  # Extract the whole archive to c:\tools\vcpkg
  # - cd c:\tools\vcpkg
  - ps: vcpkg integrate install

before_build:
  # TODO: build with Ninja?
  # FIXME: build Release
  - ps: |
      cd "${env:APPVEYOR_BUILD_FOLDER}\odil"
      mkdir build
      cd build
      cmake `
        -G "Ninja" `
        -D"CMAKE_TOOLCHAIN_FILE=c:/tools/vcpkg/${env:VCPKG_EXPORT}/scripts/buildsystems/vcpkg.cmake" `
        -DBUILD_PYTHON_WRAPPERS=OFF -DUSE_BUILTIN_DCMTK_GETSCU=OFF `
        ..

build_script:
  # WARNING: should be $(APPVEYOR_BUILD_FOLDER)\build\$(APPVEYOR_PROJECT_NAME).sln
  ps: |
    cd "${env:APPVEYOR_BUILD_FOLDER}\odil\build"
    ninja

# TODO: test_script

# on_finish:
#   - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

cache:
  - c:\tools\vcpkg\installed\
  - c:\tools\vcpkg\vcpkg-export-20181101-093017
